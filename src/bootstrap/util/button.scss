@use "../settings.scss" as *;
@use "bootstrap/scss/variables/prefix" as *;
@use "bootstrap/scss/variables/theme-colors" as *;
@use "bootstrap/scss/variables/btn-hover-bg-shade-amount" as *;
@use "bootstrap/scss/variables/btn-hover-border-shade-amount" as *;
@use "bootstrap/scss/variables/btn-active-bg-shade-amount" as *;
@use "bootstrap/scss/variables/btn-active-border-shade-amount" as *;
@use "bootstrap/scss/variables/btn-hover-bg-tint-amount" as *;
@use "bootstrap/scss/variables/btn-hover-border-tint-amount" as *;
@use "bootstrap/scss/variables/btn-active-bg-tint-amount" as *;
@use "bootstrap/scss/variables/btn-active-border-tint-amount" as *;
@use "bootstrap/scss/variables/btn-disabled-opacity" as *;
@use "bootstrap/scss/functions/shade-color" as *;
@use "bootstrap/scss/functions/tint-color" as *;
@use "bootstrap/scss/functions/color-contrast" as *;
@use "bootstrap/scss/functions/contrast-ratio" as *;
@use "bootstrap/scss/functions/to-rgb" as *;
@use "bootstrap/scss/_buttons.scss" as *;
@use "bootstrap/scss/variables/btn-focus-width" as *;
@use "bootstrap/scss/mixins/buttons" as *;
@use "bootstrap/scss/helpers/visually-hidden" as *;
@use "sass:math";
@use "sass:map";


$bonus-theme-colors: (
    "subtle",
    "contrasting"
);

// Function that returns a 50% opacity outline
// for a button of a given color.
// Black for most colors, white for very dark colors.
@function subtle-contrast($color) {
    @if contrast-ratio($color, black) > 3 {
        @return rgba(0, 0, 0, 0.5);
    }
    @else {
        @return color(from #{color-contrast($color)} srgb r g b / 0.5);
    }
}

// Add the light/dark-theme sensitive "subtle" and "contrasting" colors.
// They just inherit the light/dark colors, but which is used depends on the theme.
@each $color in $bonus-theme-colors {
    .btn-#{$color} {

        [data-bs-theme="light"] &,
        &[data-bs-theme="light"] {
            @if $color =="subtle" {
                $value: map.get($theme-colors, "light");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-variant($value,
                    $value,
                    $hover-background: shade-color($value, $btn-hover-bg-shade-amount),
                    $hover-border: shade-color($value, $btn-hover-border-shade-amount),
                    $active-background: shade-color($value, $btn-active-bg-shade-amount),
                    $active-border: shade-color($value, $btn-active-border-shade-amount));
            }

            @else if $color =="contrasting" {
                $value: map.get($theme-colors, "dark");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-variant($value,
                    $value,
                    $hover-background: tint-color($value, $btn-hover-bg-tint-amount),
                    $hover-border: tint-color($value, $btn-hover-border-tint-amount),
                    $active-background: tint-color($value, $btn-active-bg-tint-amount),
                    $active-border: tint-color($value, $btn-active-border-tint-amount));
            }
        }

        [data-bs-theme="dark"] &,
        &[data-bs-theme="dark"] {
            @if $color =="contrasting" {
                $value: map.get($theme-colors, "light");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-variant($value,
                    $value,
                    $hover-background: shade-color($value, $btn-hover-bg-shade-amount),
                    $hover-border: shade-color($value, $btn-hover-border-shade-amount),
                    $active-background: shade-color($value, $btn-active-bg-shade-amount),
                    $active-border: shade-color($value, $btn-active-border-shade-amount));
            }

            @else if $color =="subtle" {
                $value: map.get($theme-colors, "dark");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-variant($value,
                    $value,
                    $hover-background: tint-color($value, $btn-hover-bg-tint-amount),
                    $hover-border: tint-color($value, $btn-hover-border-tint-amount),
                    $active-background: tint-color($value, $btn-active-bg-tint-amount),
                    $active-border: tint-color($value, $btn-active-border-tint-amount));
            }
        }
    }


    .btn-outline-#{$color} {

        [data-bs-theme="light"] &,
        &[data-bs-theme="light"] {
            @if $color =="subtle" {
                $value: map.get($theme-colors, "light");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-outline-variant($value);
            }

            @else if $color =="contrasting" {
                $value: map.get($theme-colors, "dark");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-outline-variant($value);
            }
        }

        [data-bs-theme="dark"] &,
        &[data-bs-theme="dark"] {
            @if $color =="contrasting" {
                $value: map.get($theme-colors, "light");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-outline-variant($value);
            }

            @else if $color =="subtle" {
                $value: map.get($theme-colors, "dark");
                --bs-theme-color: #{$value};
                --bs-theme-color-contrast: #{subtle-contrast($value)};
                @include button-outline-variant($value);
            }
        }
    }
}


// Create a helper variable for each theme style
// that, regardless of anything we overwrite or the filled/outlined style,
// contains the color to use
// (we can't just use, e.g., the bg color, because outlined buttons are transparent)
@each $color, $value in $theme-colors {
    .btn.btn-theme-#{$color} {
        --bs-theme-color: #{$value};
        --bs-theme-color-contrast: #{subtle-contrast($value)};
    }
}

// We override the actual border color,
// so create a helper variable that we actually use
.btn.btn-fill {
    --bs-btn-pseudo-border-color: var(--bs-theme-color-contrast);
    --bs-btn-pseudo-border-color-shade: color(from var(--bs-theme-color) srgb calc(r / 2) calc(g / 2) calc(b / 2) / 1);
    &.btn-flush {
        --bs-btn-pseudo-border-color: transparent;
    }
    //--bs-btn-pseudo-border-color: green;
    //--bs-btn-pseudo-border-color-shade: red;
}

// Override the hover styles to shade the buttons 
// instead of swinging wildly from white to red or whatever.
//
// We also set the text color always be black (or white) for
// contrast reasons
.btn.btn-outline {
    --bs-btn-hover-bg: color(from var(--bs-theme-color) srgb r g b / 33.33%);
    --bs-btn-active-bg: color(from var(--bs-theme-color) srgb r g b / 22.5%);
    --bs-btn-hover-color: var(--bs-body-color);
    --bs-btn-color: var(--bs-body-color);
    --bs-btn-active-color: var(--bs-body-color);
    --bs-btn-pseudo-border-color: var(--bs-theme-color);//color(from var(--bs-theme-color) srgb calc(r / 2) calc(g / 2) calc(b / 2) / 1);
    --bs-btn-pseudo-border-color-shade: color(from var(--bs-theme-color) srgb calc(r / 2) calc(g / 2) calc(b / 2) / 1);

    &.btn-flush {
        --bs-btn-pseudo-border-color: transparent;
    }

    &.btn-tactile-inset {
        [data-bs-theme="dark"] &,
        &[data-bs-theme="dark"] {
            --bs-btn-pseudo-border-color-shade: color(from var(--bs-theme-color) srgb calc(r / 4) calc(g / 4) calc(b / 4) / 1);
        }
    }
    //--bs-btn-pseudo-border-color: green;
    //--bs-btn-pseudo-border-color-shade: red;
    
    --bs-btn-disabled-bg: color(from var(--bs-theme-color) srgb r g b / 33.33%);
    --bs-btn-disabled-color: color(from var(--bs-body-color) srgb r g b / #{$btn-disabled-opacity});
    --#{$prefix}btn-disabled-opacity: 1;
}


.btn.tactile {
    border: none;

    // Define how "deep" the buttons are
    --bs-btn-z-height-base: 0.3333em;
    &.btn-sm { --bs-btn-z-height-base: 0.25em; }
    &.btn-lg { --bs-btn-z-height-base: 0.4em; }


    // We turn this off unless explicitly enabled
    // because "active" is ambiguous in a lot of cases.
    // We rely on "pressed" and "pressing" instead.
    --bs-btn-active-shadow:     var(--bs-btn-box-shadow);

    // When pressing/pressed
    // re-enable the active shadows
    &.pressing, &.disabled, &:disabled {
        --bs-btn-active-shadow: var(--bs-btn-pressing-shadow);
        --bs-btn-box-shadow:    var(--bs-btn-pressing-shadow);
    }
    &.selected {
        --bs-btn-active-shadow: var(--bs-btn-pressed-shadow);
        --bs-btn-box-shadow:    var(--bs-btn-pressed-shadow);
        --bs-btn-box-shadow: var(--bs-btn-pressed-shadow);
        color: var(--bs-btn-active-color);
        background: var(--bs-btn-active-bg);
    }

    // When disabled, use the same shadow as being pressed
    &.disabled, &:disabled {
        // Bootstrap actually removes the shadow from disabled buttons,
        // so we have to add it back in manually, including the focus ring.
        box-shadow: var(--bs-btn-pressing-shadow), 0 0 0 transparent;
        &:focus-visible {
            box-shadow: var(--bs-btn-pressing-shadow), var(--#{$prefix}btn-focus-box-shadow);
        }
    }

    --bs-btn-box-shadow: var(--bs-btn-default-shadow);
    &.pressing {
        --bs-btn-box-shadow: var(--bs-btn-pressing-shadow);
    }

    &.btn-outline {
        --bs-btn-bg: var(--bs-body-bg);
    }

    &.btn-tactile-inset {
        
        // The "top" side of the theoretical material holding the button
        --shadow1-default:  inset 0 0 0 0px var(--bs-btn-pseudo-border-color-shade);
        --shadow1-pressing: inset 0 var(--bs-btn-z-height-base) 0 0px var(--bs-btn-pseudo-border-color-shade);
        --shadow1-pressed:  inset 0 var(--bs-btn-z-height-base) 0 0px var(--bs-btn-pseudo-border-color-shade);

        // The part that hides the top part of the button
        // (not used for inset buttons, but kept to allow for transitions between the two)
        --shadow2-default: inset 0 0px 0 0px var(--bs-body-bg);
        --shadow2-pressing: inset 0 0 0 0px var(--bs-body-bg);
        --shadow2-pressed: inset 0 0 0 0px var(--bs-body-bg);

        // The top half of the outline
        --shadow3-default: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);
        --shadow3-pressing: inset 0 0 0 1px var(--bs-btn-pseudo-border-color);
        --shadow3-pressed: inset 0 0 0 1px var(--bs-btn-pseudo-border-color);

        // The bottom half of the outline
        --shadow4-default: inset 0 0 0 1px var(--bs-btn-pseudo-border-color);
        --shadow4-pressing: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);
        --shadow4-pressed: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);

        // Hide all the borders
        --bs-btn-border-color: var(--bs-body-bg);
        --bs-btn-hover-border-color: var(--bs-body-bg);
        --bs-btn-active-border-color: var(--bs-body-bg);
        --bs-btn-disabled-border-color: var(--bs-body-bg);

        --bs-btn-default-shadow:   var(--shadow2-default),  var(--shadow3-default),  var(--shadow4-default),  var(--shadow1-default);
        --bs-btn-pressing-shadow:  var(--shadow2-pressing), var(--shadow3-pressing), var(--shadow4-pressing), var(--shadow1-pressing);
        --bs-btn-pressed-shadow:   var(--shadow2-pressed),  var(--shadow3-pressed),  var(--shadow4-pressed),  var(--shadow1-pressed);
        
        &>.btn-label {
            position: relative;
            display: inline-block;
            transform: translateY(0px);
            transition: transform #{$btn-transition-duration} ease-in-out;
        }

        &.pressing, &.selected, &.pending {
            &>.btn-label {
                transform: translateY(calc(var(--bs-btn-z-height-base)));
            }
        }
    }

    &.btn-tactile-outset {

        // The "bottom" side of the button
        --shadow1-default:  inset 0 calc(-1 * var(--bs-btn-z-height-base)) 0 0px var(--bs-btn-pseudo-border-color-shade);
        --shadow1-pressing: inset 0 0px 0 0px var(--bs-btn-pseudo-border-color-shade);
        --shadow1-pressed:  inset 0 0px 0 0px var(--bs-btn-pseudo-border-color-shade);

        // The part that hides the top part of the button
        --shadow2-default: inset 0 0px 0 0px var(--bs-body-bg);
        --shadow2-pressing: inset 0 var(--bs-btn-z-height-base) 0 0px var(--bs-btn-pseudo-border-color-shade);
        --shadow2-pressed: inset 0 var(--bs-btn-z-height-base) 0 0px var(--bs-btn-pseudo-border-color-shade);

        // The top half of the outline
        --shadow3-default: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);
        --shadow3-pressing: inset 0 var(--bs-btn-z-height-base) 0 1px var(--bs-btn-pseudo-border-color);
        --shadow3-pressed: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);

        // The bottom half of the outline
        --shadow4-default: inset 0 calc(-1 * var(--bs-btn-z-height-base)) 0 1px var(--bs-btn-pseudo-border-color);
        --shadow4-pressing: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);
        --shadow4-pressed: inset 0 0px 0 1px var(--bs-btn-pseudo-border-color);

        // Hide all the borders
        --bs-btn-border-color: var(--bs-body-bg);
        --bs-btn-hover-border-color: var(--bs-body-bg);
        --bs-btn-active-border-color: var(--bs-body-bg);
        --bs-btn-disabled-border-color: var(--bs-body-bg);

        --bs-btn-default-shadow:  var(--shadow1-default),  var(--shadow2-default),  var(--shadow3-default),  var(--shadow4-default);
        --bs-btn-pressing-shadow: var(--shadow1-pressing), var(--shadow2-pressing), var(--shadow3-pressing), var(--shadow4-pressing);
        --bs-btn-pressed-shadow:  var(--shadow1-pressed),  var(--shadow2-pressed),  var(--shadow3-pressed),  var(--shadow4-pressed);

        
        &>.btn-label {
            position: relative;
            display: inline-block;
            transform: translateY(calc(var(--bs-btn-z-height-base) / -2));
            transition: transform #{$btn-transition-duration} ease-in-out;
        }

        &.pressing, &.selected, &.pending {
            &>.btn-label {
                transform: translateY(calc(var(--bs-btn-z-height-base) / 2));
            }
        }
    }
}


.btn {
    position: relative;

    // Make sure that the spinner appears in the right spot on the tactile buttons
    --bs-spinner-top-offset: 0;
    
    &.tactile {
        &.selected, &.pressing, &.pending {
            --bs-spinner-top-offset: var(--bs-btn-z-height-base, 0);
        }
    }
    &>.spinner {
        position: absolute;
        inset: 0;
        top: var(--bs-spinner-top-offset, 0);
        z-index: 1;
        pointer-events: none;
            transition: top #{$btn-transition-duration} ease-in-out;
        &>.spinner-border {
            --bs-spinner-height: 1.2em;
            --bs-spinner-width: 1.2em;
            transition: opacity 0.15s ease-in-out;
        }
    }
}